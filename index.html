<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Distribuci√≥n Juguetes - FASE 1 Completo</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-container h1 { color: #667eea; margin-bottom: 10px; text-align: center; font-size: 2em; }
        .login-container p { color: #6b7280; margin-bottom: 30px; text-align: center; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .header-info h1 { font-size: 2em; margin-bottom: 5px; }
        .header-info .subtitle { opacity: 0.9; font-size: 0.95em; }
        .header-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; }
        .user-role {
            font-size: 0.85em;
            padding: 2px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.online { background: #4ade80; }
        .status-dot.offline { background: #fbbf24; }
        .status-dot.syncing { background: #60a5fa; }
        .status-dot.error { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .main-content { padding: 30px; }
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; border-radius: 6px; }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-card .subtitle { font-size: 0.85em; opacity: 0.8; }
        .form-container { background: #f9fafb; padding: 30px; border-radius: 15px; }
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .form-section h3 { color: #667eea; margin-bottom: 15px; font-size: 1.2em; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .alert-warning { background: #fef3c7; color: #92400e; border: 2px solid #fbbf24; }
        .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filters-panel {
            padding: 20px;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .search-box { position: relative; }
        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1em;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 1.2em;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        td { padding: 15px; border-bottom: 1px solid #e5e7eb; }
        tbody tr:hover { background: #f9fafb; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-delivered { background: #d1fae5; color: #065f46; }
        .badge-superuser { background: #fee2e2; color: #991b1b; }
        .badge-admin { background: #dbeafe; color: #1e40af; }
        .badge-operator { background: #f3e8ff; color: #6b21a8; }
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { color: #667eea; margin: 0; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { color: #374151; }
        .modal-body { padding: 25px; }
        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.5em; margin-bottom: 10px; color: #374151; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; }
            .main-content { padding: 20px; }
            .nav-buttons, .filters-row { grid-template-columns: 1fr; }
            table { font-size: 0.9em; }
            th, td { padding: 10px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ============================================
        // CONFIGURACI√ìN Y UTILIDADES
        // ============================================
        
        const API_CONFIG = {
            URL: 'https://script.google.com/macros/s/AKfycbyx7cSEK0crVz2YWcSUlKyrLTbv8RUNuCVHyrikPgtSz1gJaL-qfrB5XT9tYtAnYqJkiw/exec',
        };

        const DEVICE_ID = localStorage.getItem('deviceId') || (() => {
            const id = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        })();

        const isConfigured = API_CONFIG.URL !== 'TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI';

        // Utilidades RUT
        const formatRUT = (rut) => {
            const cleaned = rut.replace(/[^0-9kK]/g, '');
            if (cleaned.length <= 1) return cleaned;
            const dv = cleaned.slice(-1);
            const numbers = cleaned.slice(0, -1);
            return `${numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}-${dv}`;
        };

        const validateRUT = (rut) => {
            const cleaned = rut.replace(/[^0-9kK]/g, '');
            if (cleaned.length < 2) return false;
            const dv = cleaned.slice(-1).toLowerCase();
            const numbers = cleaned.slice(0, -1);
            let suma = 0, multiplo = 2;
            for (let i = numbers.length - 1; i >= 0; i--) {
                suma += parseInt(numbers[i]) * multiplo;
                multiplo = multiplo === 7 ? 2 : multiplo + 1;
            }
            const resto = suma % 11;
            const dvCalculado = resto === 0 ? '0' : resto === 1 ? 'k' : String(11 - resto);
            return dv === dvCalculado;
        };

        const calcularEdad = (fechaNacimiento) => {
            const hoy = new Date();
            const nacimiento = new Date(fechaNacimiento);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const mes = hoy.getMonth() - nacimiento.getMonth();
            if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
            return edad;
        };

        // ============================================
        // API CLIENT
        // ============================================
        
        class APIClient {
            static token = localStorage.getItem('authToken');
            
            static setToken(token) {
                this.token = token;
                if (token) {
                    localStorage.setItem('authToken', token);
                } else {
                    localStorage.removeItem('authToken');
                }
            }
            
            static async request(action, data = {}) {
                try {
                    const response = await fetch(API_CONFIG.URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action,
                            token: this.token,
                            deviceId: DEVICE_ID,
                            ...data
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        if (result.message.includes('Sesi√≥n')) {
                            this.setToken(null);
                            throw new Error('SESSION_EXPIRED');
                        }
                        throw new Error(result.message);
                    }
                    
                    return result.data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            }
            
            static async login(username, password) {
                try {
                    const response = await fetch(API_CONFIG.URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'login',
                            username,
                            password,
                            deviceId: DEVICE_ID
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.setToken(result.data.token);
                        return result.data;
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Login Error:', error);
                    throw error;
                }
            }
            
            static logout() {
                this.setToken(null);
            }
            
            // M√©todos de datos
            static async sync() { return await this.request('sync'); }
            static async addBeneficiario(b) { return await this.request('addBeneficiario', { beneficiario: b }); }
            static async updateBeneficiario(id, updates) { return await this.request('updateBeneficiario', { id, updates }); }
            static async deleteBeneficiario(id) { return await this.request('deleteBeneficiario', { id }); }
            static async addSector(s) { return await this.request('addSector', { sector: s }); }
            static async deleteSector(s) { return await this.request('deleteSector', { sector: s }); }
            static async addEntrega(e) { return await this.request('addEntrega', { entrega: e }); }
            
            // M√©todos de usuarios
            static async getUsuarios() { return await this.request('getUsuarios'); }
            static async addUsuario(u) { return await this.request('addUsuario', { usuario: u }); }
            static async updateUsuario(id, updates) { return await this.request('updateUsuario', { id, updates }); }
            static async deleteUsuario(id) { return await this.request('deleteUsuario', { id }); }
            static async cambiarPassword(id, newPassword) { return await this.request('cambiarPassword', { id, newPassword }); }
        }

        // ============================================
        // COMPONENTES B√ÅSICOS
        // ============================================
        
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const userData = await APIClient.login(username, password);
                    onLogin(userData.usuario);
                } catch (err) {
                    setError(err.message || 'Error al iniciar sesi√≥n');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <h1>üéÅ Bienvenido</h1>
                    <p>Sistema de Distribuci√≥n de Juguetes</p>
                    
                    {error && (
                        <div className="alert alert-error">
                            <span>‚ùå</span>
                            <span>{error}</span>
                        </div>
                    )}
                    
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label>Usuario</label>
                            <input 
                                type="text"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                placeholder="Ingresa tu usuario"
                                required
                                autoFocus
                            />
                        </div>
                        
                        <div className="form-group">
                            <label>Contrase√±a</label>
                            <input 
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="Ingresa tu contrase√±a"
                                required
                            />
                        </div>
                        
                        <button 
                            type="submit" 
                            className="btn btn-primary" 
                            style={{width: '100%', marginTop: '10px'}}
                            disabled={loading}
                        >
                            {loading ? 'Verificando...' : 'üîê Ingresar'}
                        </button>
                    </form>
                    
                    <div className="alert alert-info" style={{marginTop: '20px'}}>
                        <span>‚ÑπÔ∏è</span>
                        <div style={{fontSize: '0.85em'}}>
                            <strong>Usuarios por defecto:</strong><br/>
                            superadmin / Super2024!<br/>
                            admin / Admin2024!<br/>
                            operador / Operador2024!
                        </div>
                    </div>
                </div>
            );
        }

        function Header({ syncStatus, currentUser, onLogout }) {
            const getStatusClass = () => {
                switch(syncStatus.status) {
                    case 'online': return 'online';
                    case 'offline': return 'offline';
                    case 'syncing': return 'syncing';
                    case 'error': return 'error';
                    default: return 'offline';
                }
            };
            
            const getInitials = (name) => {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            };
            
            return (
                <div className="header">
                    <div className="header-content">
                        <div className="header-info">
                            <h1>üéÅ Sistema de Distribuci√≥n de Juguetes</h1>
                            <div className="subtitle">
                                FASE 1 Completo ‚Ä¢ Dispositivo: {DEVICE_ID.substring(7, 12)}
                            </div>
                            <div className="sync-status">
                                <div className={`status-dot ${getStatusClass()}`}></div>
                                <span>{syncStatus.message}</span>
                                {syncStatus.lastSync && (
                                    <span style={{opacity: 0.8}}>
                                        {' '}‚Ä¢ {syncStatus.lastSync.toLocaleTimeString('es-CL')}
                                    </span>
                                )}
                            </div>
                        </div>
                        
                        <div className="header-user">
                            <div className="user-badge">
                                <div className="user-avatar">{getInitials(currentUser.nombre)}</div>
                                <div className="user-info">
                                    <div className="user-name">{currentUser.nombre}</div>
                                    <div className="user-role">{currentUser.rol}</div>
                                </div>
                            </div>
                            <button className="logout-btn" onClick={onLogout}>
                                üö™ Salir
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Navigation({ currentView, setCurrentView, userPermissions }) {
            const menuItems = [
                { id: 'dashboard', icon: 'üìä', label: 'Dashboard', show: true },
                { id: 'nuevo', icon: '‚ûï', label: 'Nuevo', show: userPermissions.crearBeneficiarios },
                { id: 'listado', icon: 'üìã', label: 'Listado', show: userPermissions.verBeneficiarios },
                { id: 'sectores', icon: 'üó∫Ô∏è', label: 'Sectores', show: userPermissions.verSectores },
                { id: 'usuarios', icon: 'üë•', label: 'Usuarios', show: userPermissions.verUsuarios }
            ];
            
            return (
                <div className="nav-buttons">
                    {menuItems.filter(item => item.show).map(item => (
                        <button 
                            key={item.id}
                            className={`btn ${currentView === item.id ? 'btn-primary' : 'btn-secondary'}`}
                            onClick={() => setCurrentView(item.id)}
                        >
                            {item.icon} {item.label}
                        </button>
                    ))}
                </div>
            );
        }

        function Dashboard({ stats, setCurrentView }) {
            return (
                <div>
                    <h2 style={{marginBottom: '20px', color: '#374151'}}>üìä Panel de Control</h2>
                    
                    <div className="dashboard">
                        <div className="stat-card">
                            <h3>Total Beneficiarios</h3>
                            <div className="number">{stats.total}</div>
                            <div className="subtitle">Ni√±os registrados</div>
                        </div>
                        
                        <div className="stat-card">
                            <h3>Entregas Realizadas</h3>
                            <div className="number">{stats.entregados}</div>
                            <div className="subtitle">{stats.total > 0 ? Math.round((stats.entregados / stats.total) * 100) : 0}% completado</div>
                        </div>
                        
                        <div className="stat-card">
                            <h3>Pendientes</h3>
                            <div className="number">{stats.pendientes}</div>
                            <div className="subtitle">Por entregar</div>
                        </div>
                    </div>
                    
                    {stats.porSector && stats.porSector.length > 0 && (
                        <div>
                            <h3 style={{marginTop: '30px', marginBottom: '15px', color: '#667eea'}}>
                                üìç Estad√≠sticas por Sector
                            </h3>
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Sector</th>
                                            <th>Total</th>
                                            <th>Entregados</th>
                                            <th>Pendientes</th>
                                            <th>Progreso</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {stats.porSector.map(s => (
                                            <tr key={s.sector}>
                                                <td><strong>{s.sector}</strong></td>
                                                <td>{s.total}</td>
                                                <td>{s.entregados}</td>
                                                <td>{s.pendientes}</td>
                                                <td>
                                                    <span className={`badge ${s.pendientes === 0 ? 'badge-delivered' : 'badge-pending'}`}>
                                                        {s.total > 0 ? Math.round((s.entregados / s.total) * 100) : 0}%
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    
                    <div style={{marginTop: '30px', display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                        <button className="btn btn-primary" onClick={() => setCurrentView('nuevo')}>
                            ‚ûï Registrar Nuevo Beneficiario
                        </button>
                        <button className="btn btn-secondary" onClick={() => setCurrentView('listado')}>
                            üìã Ver Listado Completo
                        </button>
                    </div>
                </div>
            );
        }

        // ============================================
        // COMPONENTES DE GESTI√ìN DE USUARIOS
        // ============================================
        
        function GestionUsuarios({ usuarios, currentUser, onAdd, onUpdate, onDelete, onChangePassword }) {
            const [showModal, setShowModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [showPasswordModal, setShowPasswordModal] = useState(null);
            
            const handleEdit = (user) => {
                setEditingUser(user);
                setShowModal(true);
            };
            
            const handleAdd = () => {
                setEditingUser(null);
                setShowModal(true);
            };
            
            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h2 style={{color: '#374151'}}>üë• Gesti√≥n de Usuarios</h2>
                        {currentUser.permisos.crearUsuarios && (
                            <button className="btn btn-primary" onClick={handleAdd}>
                                ‚ûï Nuevo Usuario
                            </button>
                        )}
                    </div>
                    
                    <div className="table-container">
                        {usuarios.length === 0 ? (
                            <div className="empty-state">
                                <div className="icon">üë•</div>
                                <h3>No hay usuarios registrados</h3>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Nombre</th>
                                        <th>Rol</th>
                                        <th>Email</th>
                                        <th>Estado</th>
                                        <th>√öltimo Login</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {usuarios.map(user => (
                                        <tr key={user.id}>
                                            <td><strong>{user.username}</strong></td>
                                            <td>{user.nombre}</td>
                                            <td>
                                                <span className={`badge badge-${
                                                    user.rol === 'SUPERUSUARIO' ? 'superuser' :
                                                    user.rol === 'ADMINISTRADOR' ? 'admin' : 'operator'
                                                }`}>
                                                    {user.rol}
                                                </span>
                                            </td>
                                            <td>{user.email || '-'}</td>
                                            <td>
                                                <span className={`badge ${user.activo ? 'badge-delivered' : 'badge-pending'}`}>
                                                    {user.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
                                                </span>
                                            </td>
                                            <td>{user.ultimoLogin ? new Date(user.ultimoLogin).toLocaleDateString('es-CL') : 'Nunca'}</td>
                                            <td>
                                                <div className="action-buttons">
                                                    {currentUser.permisos.editarUsuarios && (
                                                        <button 
                                                            className="btn btn-primary btn-small"
                                                            onClick={() => handleEdit(user)}
                                                        >
                                                            ‚úèÔ∏è Editar
                                                        </button>
                                                    )}
                                                    {currentUser.permisos.editarUsuarios && (
                                                        <button 
                                                            className="btn btn-warning btn-small"
                                                            onClick={() => setShowPasswordModal(user)}
                                                        >
                                                            üîë Password
                                                        </button>
                                                    )}
                                                    {currentUser.permisos.eliminarUsuarios && user.id !== currentUser.id && (
                                                        <button 
                                                            className="btn btn-danger btn-small"
                                                            onClick={() => {
                                                                if (confirm(`¬øEliminar usuario ${user.username}?`)) {
                                                                    onDelete(user.id);
                                                                }
                                                            }}
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                    
                    {showModal && (
                        <ModalUsuario
                            user={editingUser}
                            currentUserRole={currentUser.rol}
                            onClose={() => setShowModal(false)}
                            onSave={editingUser ? onUpdate : onAdd}
                        />
                    )}
                    
                    {showPasswordModal && (
                        <ModalPassword
                            user={showPasswordModal}
                            onClose={() => setShowPasswordModal(null)}
                            onSave={(newPassword) => {
                                onChangePassword(showPasswordModal.id, newPassword);
                                setShowPasswordModal(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        function ModalUsuario({ user, currentUserRole, onClose, onSave }) {
            const [formData, setFormData] = useState({
                username: user?.username || '',
                nombre: user?.nombre || '',
                email: user?.email || '',
                rol: user?.rol || 'OPERADOR',
                password: '',
                activo: user?.activo ?? true
            });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (!user && !formData.password) {
                    setError('La contrase√±a es obligatoria para nuevos usuarios');
                    return;
                }
                
                if (currentUserRole === 'ADMINISTRADOR' && formData.rol === 'SUPERUSUARIO') {
                    setError('No tienes permisos para crear superusuarios');
                    return;
                }
                
                setLoading(true);
                try {
                    if (user) {
                        const updates = {
                            nombre: formData.nombre,
                            email: formData.email,
                            rol: formData.rol,
                            activo: formData.activo
                        };
                        await onSave(user.id, updates);
                    } else {
                        await onSave(formData);
                    }
                    onClose();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>{user ? '‚úèÔ∏è Editar Usuario' : '‚ûï Nuevo Usuario'}</h2>
                            <button className="modal-close" onClick={onClose}>‚úï</button>
                        </div>
                        <div className="modal-body">
                            {error && (
                                <div className="alert alert-error">
                                    <span>‚ùå</span>
                                    <span>{error}</span>
                                </div>
                            )}
                            
                            <form onSubmit={handleSubmit}>
                                <div className="form-group">
                                    <label>Username *</label>
                                    <input 
                                        type="text"
                                        value={formData.username}
                                        onChange={(e) => setFormData({...formData, username: e.target.value})}
                                        required
                                        disabled={!!user}
                                    />
                                </div>
                                
                                {!user && (
                                    <div className="form-group">
                                        <label>Contrase√±a *</label>
                                        <input 
                                            type="password"
                                            value={formData.password}
                                            onChange={(e) => setFormData({...formData, password: e.target.value})}
                                            required={!user}
                                            minLength="6"
                                        />
                                    </div>
                                )}
                                
                                <div className="form-group">
                                    <label>Nombre Completo *</label>
                                    <input 
                                        type="text"
                                        value={formData.nombre}
                                        onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label>Email</label>
                                    <input 
                                        type="email"
                                        value={formData.email}
                                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label>Rol *</label>
                                    <select 
                                        value={formData.rol}
                                        onChange={(e) => setFormData({...formData, rol: e.target.value})}
                                        disabled={currentUserRole === 'ADMINISTRADOR'}
                                    >
                                        <option value="OPERADOR">Operador</option>
                                        <option value="ADMINISTRADOR">Administrador</option>
                                        {currentUserRole === 'SUPERUSUARIO' && (
                                            <option value="SUPERUSUARIO">Superusuario</option>
                                        )}
                                    </select>
                                </div>
                                
                                {user && (
                                    <div className="form-group">
                                        <label style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                            <input 
                                                type="checkbox"
                                                checked={formData.activo}
                                                onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                                            />
                                            Usuario Activo
                                        </label>
                                    </div>
                                )}
                                
                                <div className="modal-footer">
                                    <button type="button" className="btn btn-secondary" onClick={onClose} disabled={loading}>
                                        Cancelar
                                    </button>
                                    <button type="submit" className="btn btn-success" disabled={loading}>
                                        {loading ? 'Guardando...' : (user ? 'üíæ Guardar Cambios' : '‚ûï Crear Usuario')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function ModalPassword({ user, onClose, onSave }) {
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (password.length < 6) {
                    setError('La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }
                
                if (password !== confirmPassword) {
                    setError('Las contrase√±as no coinciden');
                    return;
                }
                
                setLoading(true);
                try {
                    await onSave(password);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>üîë Cambiar Contrase√±a</h2>
                            <button className="modal-close" onClick={onClose}>‚úï</button>
                        </div>
                        <div className="modal-body">
                            <p style={{marginBottom: '20px'}}>
                                <strong>Usuario:</strong> {user.username} ({user.nombre})
                            </p>
                            
                            {error && (
                                <div className="alert alert-error">
                                    <span>‚ùå</span>
                                    <span>{error}</span>
                                </div>
                            )}
                            
                            <form onSubmit={handleSubmit}>
                                <div className="form-group">
                                    <label>Nueva Contrase√±a *</label>
                                    <input 
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        minLength="6"
                                        required
                                        autoFocus
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label>Confirmar Contrase√±a *</label>
                                    <input 
                                        type="password"
                                        value={confirmPassword}
                                        onChange={(e) => setConfirmPassword(e.target.value)}
                                        minLength="6"
                                        required
                                    />
                                </div>
                                
                                <div className="modal-footer">
                                    <button type="button" className="btn btn-secondary" onClick={onClose} disabled={loading}>
                                        Cancelar
                                    </button>
                                    <button type="submit" className="btn btn-warning" disabled={loading}>
                                        {loading ? 'Cambiando...' : 'üîë Cambiar Contrase√±a'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // COMPONENTE FORMULARIO BENEFICIARIO
        function FormularioBeneficiario({ sectores, beneficiarios, onSave, onCancel }) {
            const [formData, setFormData] = useState({
                rut: '',
                nombre: '',
                apellidos: '',
                fechaNacimiento: '',
                responsable: { nombre: '', rut: '', telefono: '' },
                domicilio: '',
                sector: sectores[0] || '',
                observaciones: ''
            });
            const [errors, setErrors] = useState({});
            const [warnings, setWarnings] = useState([]);

            const handleChange = (field, value) => {
                if (field.includes('.')) {
                    const [parent, child] = field.split('.');
                    setFormData(prev => ({
                        ...prev,
                        [parent]: { ...prev[parent], [child]: value }
                    }));
                } else {
                    setFormData(prev => ({...prev, [field]: value}));
                }
                setErrors(prev => ({...prev, [field]: null}));
            };

            const handleRutChange = (field, value) => {
                handleChange(field, formatRUT(value));
            };

            useEffect(() => {
                const duplicados = [];
                if (formData.rut && validateRUT(formData.rut)) {
                    const existeRut = beneficiarios.find(b => b.rut === formData.rut);
                    if (existeRut) {
                        duplicados.push(`‚ö†Ô∏è Ya existe un beneficiario con este RUT: ${existeRut.nombre} ${existeRut.apellidos}`);
                    }
                }
                if (formData.responsable.rut && validateRUT(formData.responsable.rut) && formData.domicilio) {
                    const mismoDomicilio = beneficiarios.find(b => 
                        b.responsable.rut === formData.responsable.rut && 
                        b.domicilio.toLowerCase() === formData.domicilio.toLowerCase()
                    );
                    if (mismoDomicilio) {
                        duplicados.push(`‚ö†Ô∏è Posible duplicado: mismo adulto responsable y domicilio`);
                    }
                }
                setWarnings(duplicados);
            }, [formData.rut, formData.responsable.rut, formData.domicilio, beneficiarios]);

            const validate = () => {
                const newErrors = {};
                if (!formData.rut) newErrors.rut = 'El RUT es obligatorio';
                else if (!validateRUT(formData.rut)) newErrors.rut = 'RUT inv√°lido';
                if (!formData.nombre.trim()) newErrors.nombre = 'El nombre es obligatorio';
                if (!formData.apellidos.trim()) newErrors.apellidos = 'Los apellidos son obligatorios';
                if (!formData.fechaNacimiento) newErrors.fechaNacimiento = 'La fecha de nacimiento es obligatoria';
                if (formData.fechaNacimiento) {
                    const edad = calcularEdad(formData.fechaNacimiento);
                    if (edad < 0 || edad > 10) {
                        newErrors.fechaNacimiento = 'La edad debe estar entre 0 y 10 a√±os';
                    }
                }
                if (!formData.responsable.nombre.trim()) newErrors['responsable.nombre'] = 'El nombre del responsable es obligatorio';
                if (!formData.responsable.rut) newErrors['responsable.rut'] = 'El RUT del responsable es obligatorio';
                else if (!validateRUT(formData.responsable.rut)) newErrors['responsable.rut'] = 'RUT del responsable inv√°lido';
                if (!formData.domicilio.trim()) newErrors.domicilio = 'El domicilio es obligatorio';
                if (!formData.sector) newErrors.sector = 'Debe seleccionar un sector';
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (validate()) {
                    await onSave(formData);
                    alert('‚úÖ Beneficiario guardado exitosamente');
                    onCancel();
                }
            };

            const edad = formData.fechaNacimiento ? calcularEdad(formData.fechaNacimiento) : null;

            return (
                <form className="form-container" onSubmit={handleSubmit}>
                    <h2 style={{marginBottom: '20px', color: '#667eea'}}>‚ûï Nuevo Beneficiario</h2>
                    {warnings.length > 0 && (
                        <div className="alert alert-warning">
                            <span style={{fontSize: '1.5em'}}>‚ö†Ô∏è</span>
                            <div>{warnings.map((w, i) => <div key={i}>{w}</div>)}</div>
                        </div>
                    )}
                    <div className="form-section">
                        <h3>üë∂ Datos del Ni√±o/a</h3>
                        <div className="form-group">
                            <label>RUT *</label>
                            <input 
                                type="text"
                                placeholder="12.345.678-9"
                                value={formData.rut}
                                onChange={(e) => handleRutChange('rut', e.target.value)}
                                maxLength="12"
                            />
                            {errors.rut && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors.rut}</div>}
                        </div>
                        <div className="form-row">
                            <div className="form-group">
                                <label>Nombre *</label>
                                <input 
                                    type="text"
                                    placeholder="Nombre"
                                    value={formData.nombre}
                                    onChange={(e) => handleChange('nombre', e.target.value)}
                                />
                                {errors.nombre && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors.nombre}</div>}
                            </div>
                            <div className="form-group">
                                <label>Apellidos *</label>
                                <input 
                                    type="text"
                                    placeholder="Apellidos"
                                    value={formData.apellidos}
                                    onChange={(e) => handleChange('apellidos', e.target.value)}
                                />
                                {errors.apellidos && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors.apellidos}</div>}
                            </div>
                        </div>
                        <div className="form-row">
                            <div className="form-group">
                                <label>Fecha de Nacimiento *</label>
                                <input 
                                    type="date"
                                    value={formData.fechaNacimiento}
                                    onChange={(e) => handleChange('fechaNacimiento', e.target.value)}
                                    max={new Date().toISOString().split('T')[0]}
                                />
                                {errors.fechaNacimiento && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors.fechaNacimiento}</div>}
                            </div>
                            <div className="form-group">
                                <label>Edad</label>
                                <input 
                                    type="text"
                                    value={edad !== null ? `${edad} a√±o${edad !== 1 ? 's' : ''}` : ''}
                                    readOnly
                                    style={{background: '#f3f4f6', cursor: 'not-allowed'}}
                                />
                            </div>
                        </div>
                    </div>
                    <div className="form-section">
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Adulto Responsable</h3>
                        <div className="form-group">
                            <label>Nombre Completo *</label>
                            <input 
                                type="text"
                                placeholder="Nombre completo del adulto responsable"
                                value={formData.responsable.nombre}
                                onChange={(e) => handleChange('responsable.nombre', e.target.value)}
                            />
                            {errors['responsable.nombre'] && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors['responsable.nombre']}</div>}
                        </div>
                        <div className="form-row">
                            <div className="form-group">
                                <label>RUT *</label>
                                <input 
                                    type="text"
                                    placeholder="12.345.678-9"
                                    value={formData.responsable.rut}
                                    onChange={(e) => handleRutChange('responsable.rut', e.target.value)}
                                    maxLength="12"
                                />
                                {errors['responsable.rut'] && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors['responsable.rut']}</div>}
                            </div>
                            <div className="form-group">
                                <label>Tel√©fono</label>
                                <input 
                                    type="tel"
                                    placeholder="+56 9 1234 5678"
                                    value={formData.responsable.telefono}
                                    onChange={(e) => handleChange('responsable.telefono', e.target.value)}
                                />
                            </div>
                        </div>
                    </div>
                    <div className="form-section">
                        <h3>üìç Ubicaci√≥n</h3>
                        <div className="form-group">
                            <label>Domicilio *</label>
                            <input 
                                type="text"
                                placeholder="Calle, n√∫mero, villa/poblaci√≥n"
                                value={formData.domicilio}
                                onChange={(e) => handleChange('domicilio', e.target.value)}
                            />
                            {errors.domicilio && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors.domicilio}</div>}
                        </div>
                        <div className="form-group">
                            <label>Sector *</label>
                            <select 
                                value={formData.sector}
                                onChange={(e) => handleChange('sector', e.target.value)}
                            >
                                <option value="">Seleccionar sector</option>
                                {sectores.map(sector => (
                                    <option key={sector} value={sector}>{sector}</option>
                                ))}
                            </select>
                            {errors.sector && <div style={{color: '#ef4444', fontSize: '0.9em', marginTop: '5px'}}>{errors.sector}</div>}
                        </div>
                        <div className="form-group">
                            <label>Observaciones</label>
                            <textarea 
                                placeholder="Informaci√≥n adicional relevante..."
                                value={formData.observaciones}
                                onChange={(e) => handleChange('observaciones', e.target.value)}
                            />
                        </div>
                    </div>
                    <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                        <button type="button" className="btn btn-secondary" onClick={onCancel}>
                            Cancelar
                        </button>
                        <button type="submit" className="btn btn-success">
                            ‚ûï Registrar Beneficiario
                        </button>
                    </div>
                </form>
            );
        }

        // COMPONENTE LISTADO CON FILTROS AVANZADOS
        function Listado({ beneficiarios, sectores, entregas, searchTerm, setSearchTerm, filterSector, setFilterSector, filterEstado, setFilterEstado, onRegistrarEntrega, onDelete, userPermissions }) {
            const [modalEntrega, setModalEntrega] = useState(null);
            const [busquedaRUT, setBusquedaRUT] = useState('');
            const [edadMin, setEdadMin] = useState('');
            const [edadMax, setEdadMax] = useState('');
            
            const beneficiariosFiltrados = useMemo(() => {
                return beneficiarios.filter(b => {
                    const matchSearch = searchTerm === '' || 
                        b.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        b.apellidos.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        b.responsable.nombre.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    const matchRUT = busquedaRUT === '' || 
                        b.rut.replace(/[^0-9kK]/g, '').toLowerCase().includes(busquedaRUT.replace(/[^0-9kK]/g, '').toLowerCase());
                    
                    const matchSector = filterSector === 'todos' || b.sector === filterSector;
                    
                    const edad = calcularEdad(b.fechaNacimiento);
                    const matchEdad = (edadMin === '' || edad >= parseInt(edadMin)) &&
                                     (edadMax === '' || edad <= parseInt(edadMax));
                    
                    const entrega = entregas.find(e => e.beneficiarioId === b.id);
                    const estado = entrega ? entrega.estado : 'pendiente';
                    const matchEstado = filterEstado === 'todos' || estado === filterEstado;
                    
                    return matchSearch && matchRUT && matchSector && matchEdad && matchEstado;
                });
            }, [beneficiarios, searchTerm, busquedaRUT, filterSector, edadMin, edadMax, filterEstado, entregas]);

            return (
                <div>
                    <h2 style={{marginBottom: '20px', color: '#374151'}}>üìã Listado Completo</h2>
                    
                    <div className="table-container">
                        <div className="filters-panel">
                            <div className="filters-row">
                                <div className="search-box">
                                    <span className="search-icon">üîç</span>
                                    <input 
                                        type="text"
                                        placeholder="Buscar por nombre..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                
                                <div className="search-box">
                                    <span className="search-icon">üÜî</span>
                                    <input 
                                        type="text"
                                        placeholder="Buscar por RUT..."
                                        value={busquedaRUT}
                                        onChange={(e) => setBusquedaRUT(e.target.value)}
                                    />
                                </div>
                            </div>
                            
                            <div className="filters-row">
                                <div className="form-group" style={{marginBottom: 0}}>
                                    <label>Edad M√≠nima</label>
                                    <input 
                                        type="number"
                                        min="0"
                                        max="10"
                                        value={edadMin}
                                        onChange={(e) => setEdadMin(e.target.value)}
                                        placeholder="Ej: 5"
                                    />
                                </div>
                                
                                <div className="form-group" style={{marginBottom: 0}}>
                                    <label>Edad M√°xima</label>
                                    <input 
                                        type="number"
                                        min="0"
                                        max="10"
                                        value={edadMax}
                                        onChange={(e) => setEdadMax(e.target.value)}
                                        placeholder="Ej: 7"
                                    />
                                </div>
                                
                                <div className="form-group" style={{marginBottom: 0}}>
                                    <label>Sector</label>
                                    <select 
                                        value={filterSector}
                                        onChange={(e) => setFilterSector(e.target.value)}
                                    >
                                        <option value="todos">Todos</option>
                                        {sectores.map(sector => (
                                            <option key={sector} value={sector}>{sector}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div className="form-group" style={{marginBottom: 0}}>
                                    <label>Estado</label>
                                    <select 
                                        value={filterEstado}
                                        onChange={(e) => setFilterEstado(e.target.value)}
                                    >
                                        <option value="todos">Todos</option>
                                        <option value="pendiente">Pendientes</option>
                                        <option value="entregado">Entregados</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', justifyContent: 'space-between', marginTop: '15px'}}>
                                <div style={{fontSize: '0.9em', color: '#6b7280'}}>
                                    Mostrando {beneficiariosFiltrados.length} de {beneficiarios.length} beneficiarios
                                </div>
                                
                                <button 
                                    className="btn btn-secondary btn-small"
                                    onClick={() => {
                                        setSearchTerm('');
                                        setBusquedaRUT('');
                                        setEdadMin('');
                                        setEdadMax('');
                                        setFilterSector('todos');
                                        setFilterEstado('todos');
                                    }}
                                >
                                    üîÑ Limpiar Filtros
                                </button>
                            </div>
                        </div>
                        
                        {beneficiariosFiltrados.length === 0 ? (
                            <div className="empty-state">
                                <div className="icon">üîç</div>
                                <h3>No se encontraron beneficiarios</h3>
                                <p>Intenta ajustar los filtros de b√∫squeda</p>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>RUT</th>
                                        <th>Nombre Completo</th>
                                        <th>Edad</th>
                                        <th>Sector</th>
                                        <th>Responsable</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {beneficiariosFiltrados.map(b => {
                                        const entrega = entregas.find(e => e.beneficiarioId === b.id);
                                        const estado = entrega ? entrega.estado : 'pendiente';
                                        const edad = calcularEdad(b.fechaNacimiento);
                                        
                                        return (
                                            <tr key={b.id}>
                                                <td><strong>{formatRUT(b.rut)}</strong></td>
                                                <td>{b.nombre} {b.apellidos}</td>
                                                <td>{edad} a√±os</td>
                                                <td>{b.sector}</td>
                                                <td>{b.responsable.nombre}</td>
                                                <td>
                                                    <span className={`badge badge-${estado === 'entregado' ? 'delivered' : 'pending'}`}>
                                                        {estado === 'entregado' ? '‚úÖ Entregado' : '‚è≥ Pendiente'}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div className="action-buttons">
                                                        {estado !== 'entregado' && userPermissions.registrarEntregas && (
                                                            <button 
                                                                className="btn btn-success btn-small"
                                                                onClick={() => setModalEntrega(b)}
                                                            >
                                                                üéÅ Entregar
                                                            </button>
                                                        )}
                                                        {userPermissions.eliminarBeneficiarios && (
                                                            <button 
                                                                className="btn btn-danger btn-small"
                                                                onClick={() => {
                                                                    if (confirm(`¬øEliminar a ${b.nombre} ${b.apellidos}?`)) {
                                                                        onDelete(b.id);
                                                                    }
                                                                }}
                                                            >
                                                                üóëÔ∏è
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        )}
                    </div>
                    
                    {modalEntrega && (
                        <div className="modal-overlay" onClick={() => setModalEntrega(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>üéÅ Registrar Entrega</h2>
                                    <button className="modal-close" onClick={() => setModalEntrega(null)}>‚úï</button>
                                </div>
                                <div className="modal-body">
                                    <p style={{marginBottom: '20px'}}>
                                        <strong>Beneficiario:</strong> {modalEntrega.nombre} {modalEntrega.apellidos}
                                    </p>
                                    <div className="form-group">
                                        <label>Tipo de Juguete</label>
                                        <select id="tipoJuguete">
                                            <option value="Mu√±eca">Mu√±eca</option>
                                            <option value="Auto">Auto</option>
                                            <option value="Pelota">Pelota</option>
                                            <option value="Juego de Mesa">Juego de Mesa</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setModalEntrega(null)}>
                                        Cancelar
                                    </button>
                                    <button 
                                        className="btn btn-success"
                                        onClick={() => {
                                            const tipo = document.getElementById('tipoJuguete').value;
                                            onRegistrarEntrega(modalEntrega.id, tipo);
                                            setModalEntrega(null);
                                        }}
                                    >
                                        ‚úÖ Confirmar Entrega
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // COMPONENTE GESTION SECTORES
        function GestionSectores({ sectores, stats, onAdd, onDelete }) {
            const [nuevoSector, setNuevoSector] = useState('');
            const [showForm, setShowForm] = useState(false);

            const handleAdd = async () => {
                if (nuevoSector.trim()) {
                    await onAdd(nuevoSector.trim());
                    setNuevoSector('');
                    setShowForm(false);
                    alert('‚úÖ Sector agregado exitosamente');
                }
            };

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h2 style={{color: '#374151'}}>üó∫Ô∏è Gesti√≥n de Sectores</h2>
                        <button 
                            className="btn btn-primary"
                            onClick={() => setShowForm(!showForm)}
                        >
                            {showForm ? '‚úñÔ∏è Cancelar' : '‚ûï Agregar Sector'}
                        </button>
                    </div>
                    {showForm && (
                        <div className="form-container" style={{marginBottom: '20px'}}>
                            <div className="form-group">
                                <label>Nombre del Sector</label>
                                <input 
                                    type="text"
                                    placeholder="Ej: Villa Los Aromos"
                                    value={nuevoSector}
                                    onChange={(e) => setNuevoSector(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleAdd()}
                                    autoFocus
                                />
                            </div>
                            <button className="btn btn-success" onClick={handleAdd}>
                                üíæ Guardar Sector
                            </button>
                        </div>
                    )}
                    <div className="sector-list">
                        {sectores.length === 0 ? (
                            <div className="empty-state">
                                <div className="icon">üó∫Ô∏è</div>
                                <h3>No hay sectores registrados</h3>
                                <p>Comienza agregando el primer sector</p>
                            </div>
                        ) : (
                            sectores.map(sector => {
                                const sectorStats = stats.porSector.find(s => s.sector === sector);
                                const tieneBeneficiarios = sectorStats && sectorStats.total > 0;
                                return (
                                    <div key={sector} className="sector-item">
                                        <div className="sector-info">
                                            <div className="sector-name">{sector}</div>
                                            <div className="sector-stats">
                                                {sectorStats ? 
                                                    `${sectorStats.total} beneficiario${sectorStats.total !== 1 ? 's' : ''} | ${sectorStats.entregados} entregado${sectorStats.entregados !== 1 ? 's' : ''}` 
                                                    : 'Sin beneficiarios asignados'}
                                            </div>
                                        </div>
                                        <button 
                                            className="btn btn-danger btn-small"
                                            onClick={async () => {
                                                if (tieneBeneficiarios) {
                                                    alert('‚ùå No se puede eliminar un sector con beneficiarios asignados');
                                                } else if (confirm(`¬øEliminar el sector "${sector}"?`)) {
                                                    await onDelete(sector);
                                                }
                                            }}
                                        >
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // COMPONENTE PRINCIPAL APP - COMPLETO
        // ============================================
        
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [syncStatus, setSyncStatus] = useState({
                status: 'offline',
                message: 'No conectado',
                lastSync: null
            });
            const [beneficiarios, setBeneficiarios] = useState([]);
            const [sectores, setSectores] = useState([]);
            const [entregas, setEntregas] = useState([]);
            const [usuarios, setUsuarios] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterSector, setFilterSector] = useState('todos');
            const [filterEstado, setFilterEstado] = useState('todos');

            useEffect(() => {
                if (!isAuthenticated || !isConfigured) return;
                const syncData = async () => {
                    try {
                        setSyncStatus({ status: 'syncing', message: 'Sincronizando...', lastSync: null });
                        const data = await APIClient.sync();
                        setBeneficiarios(data.beneficiarios || []);
                        setSectores(data.sectores || []);
                        setEntregas(data.entregas || []);
                        if (data.usuarios) setUsuarios(data.usuarios);
                        setSyncStatus({ status: 'online', message: 'Sincronizado', lastSync: new Date() });
                    } catch (error) {
                        if (error.message === 'SESSION_EXPIRED') {
                            handleLogout();
                        } else {
                            setSyncStatus({ status: 'error', message: 'Error de conexi√≥n', lastSync: null });
                        }
                    }
                };
                syncData();
                const interval = setInterval(syncData, 30000);
                return () => clearInterval(interval);
            }, [isAuthenticated]);

            const sectorNames = useMemo(() => sectores.map(s => s.nombre), [sectores]);

            const stats = useMemo(() => {
                const total = beneficiarios.length;
                const entregados = entregas.filter(e => e.estado === 'entregado').length;
                const pendientes = total - entregados;
                const porSector = sectorNames.map(sector => {
                    const totalSector = beneficiarios.filter(b => b.sector === sector).length;
                    const entregadosSector = beneficiarios.filter(b => {
                        const entrega = entregas.find(e => e.beneficiarioId === b.id);
                        return b.sector === sector && entrega?.estado === 'entregado';
                    }).length;
                    return { sector, total: totalSector, entregados: entregadosSector, pendientes: totalSector - entregadosSector };
                });
                return { total, entregados, pendientes, porSector };
            }, [beneficiarios, sectorNames, entregas]);

            const handleAddBeneficiario = async (beneficiario) => {
                setLoading(true);
                try {
                    await APIClient.addBeneficiario(beneficiario);
                    const data = await APIClient.sync();
                    setBeneficiarios(data.beneficiarios || []);
                    alert('‚úÖ Beneficiario agregado');
                    setCurrentView('listado');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteBeneficiario = async (id) => {
                setLoading(true);
                try {
                    await APIClient.deleteBeneficiario(id);
                    const data = await APIClient.sync();
                    setBeneficiarios(data.beneficiarios || []);
                    setEntregas(data.entregas || []);
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddSector = async (nombre) => {
                setLoading(true);
                try {
                    await APIClient.addSector({ nombre });
                    const data = await APIClient.sync();
                    setSectores(data.sectores || []);
                    alert('‚úÖ Sector agregado');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteSector = async (nombre) => {
                setLoading(true);
                try {
                    await APIClient.deleteSector(nombre);
                    const data = await APIClient.sync();
                    setSectores(data.sectores || []);
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRegistrarEntrega = async (beneficiarioId, tipoJuguete) => {
                setLoading(true);
                try {
                    await APIClient.addEntrega({ beneficiarioId, tipoJuguete, estado: 'entregado', dispositivo: DEVICE_ID, usuario: currentUser?.username });
                    const data = await APIClient.sync();
                    setEntregas(data.entregas || []);
                    alert('‚úÖ Entrega registrada');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddUsuario = async (usuario) => {
                setLoading(true);
                try {
                    await APIClient.addUsuario(usuario);
                    const data = await APIClient.sync();
                    if (data.usuarios) setUsuarios(data.usuarios);
                    alert('‚úÖ Usuario creado');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleUpdateUsuario = async (id, updates) => {
                setLoading(true);
                try {
                    await APIClient.updateUsuario(id, updates);
                    const data = await APIClient.sync();
                    if (data.usuarios) setUsuarios(data.usuarios);
                    alert('‚úÖ Usuario actualizado');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteUsuario = async (id) => {
                setLoading(true);
                try {
                    await APIClient.deleteUsuario(id);
                    const data = await APIClient.sync();
                    if (data.usuarios) setUsuarios(data.usuarios);
                    alert('‚úÖ Usuario eliminado');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleChangePassword = async (id, newPassword) => {
                setLoading(true);
                try {
                    await APIClient.cambiarPassword(id, newPassword);
                    alert('‚úÖ Contrase√±a cambiada');
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = (userData) => {
                setCurrentUser(userData);
                setIsAuthenticated(true);
            };

            const handleLogout = () => {
                if (confirm('¬øCerrar sesi√≥n?')) {
                    APIClient.logout();
                    setCurrentUser(null);
                    setIsAuthenticated(false);
                    setCurrentView('dashboard');
                }
            };

            if (!isConfigured) {
                return (
                    <div className="login-container">
                        <h1>üîß Configuraci√≥n Requerida</h1>
                        <p style={{marginTop: '20px'}}>Antes de usar la aplicaci√≥n:</p>
                        <div className="alert alert-warning">
                            <span>‚ö†Ô∏è</span>
                            <div>
                                <strong>Paso 1:</strong> Despliega el backend en Google Apps Script<br/>
                                <strong>Paso 2:</strong> Copia la URL de implementaci√≥n<br/>
                                <strong>Paso 3:</strong> Edita este archivo HTML y reemplaza <strong>API_CONFIG.URL</strong>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!isAuthenticated) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return (
                <div className="app-container">
                    <Header syncStatus={syncStatus} currentUser={currentUser} onLogout={handleLogout} />
                    <div className="main-content">
                        <Navigation currentView={currentView} setCurrentView={setCurrentView} userPermissions={currentUser?.permisos || {}} />
                        
                        {loading && (
                            <div className="alert alert-info">
                                <div className="loading"></div>
                                <span>Procesando...</span>
                            </div>
                        )}
                        
                        {currentView === 'dashboard' && (
                            <Dashboard stats={stats} setCurrentView={setCurrentView} />
                        )}
                        
                        {currentView === 'nuevo' && (
                            <FormularioBeneficiario 
                                sectores={sectorNames}
                                beneficiarios={beneficiarios}
                                onSave={handleAddBeneficiario}
                                onCancel={() => setCurrentView('dashboard')}
                            />
                        )}
                        
                        {currentView === 'listado' && (
                            <Listado 
                                beneficiarios={beneficiarios}
                                sectores={sectorNames}
                                entregas={entregas}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                filterSector={filterSector}
                                setFilterSector={setFilterSector}
                                filterEstado={filterEstado}
                                setFilterEstado={setFilterEstado}
                                onRegistrarEntrega={handleRegistrarEntrega}
                                onDelete={handleDeleteBeneficiario}
                                userPermissions={currentUser?.permisos || {}}
                            />
                        )}
                        
                        {currentView === 'sectores' && (
                            <GestionSectores 
                                sectores={sectorNames}
                                stats={stats}
                                onAdd={handleAddSector}
                                onDelete={handleDeleteSector}
                            />
                        )}
                        
                        {currentView === 'usuarios' && currentUser?.permisos?.verUsuarios && (
                            <GestionUsuarios
                                usuarios={usuarios}
                                currentUser={currentUser}
                                onAdd={handleAddUsuario}
                                onUpdate={handleUpdateUsuario}
                                onDelete={handleDeleteUsuario}
                                onChangePassword={handleChangePassword}
                            />
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
